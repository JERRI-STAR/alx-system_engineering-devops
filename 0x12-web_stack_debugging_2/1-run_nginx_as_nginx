#!/usr/bin/env bash
# Fixes a web server to run Nginx as the nginx user listening on port 8080.

# Check if Nginx is already installed
if ! command -v nginx &> /dev/null; then
  echo "Nginx is not installed. Please install Nginx before running this script."
  exit 1
fi

# Stop Nginx if it's running
if systemctl is-active nginx; then
  systemctl stop nginx
fi

# Create a new user and group for Nginx
useradd -r -s /bin/false -g nginx -u 100 nginx

# Copy the Nginx configuration file to the new location
cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.original
cat << EOF > /etc/nginx/nginx.conf
user nginx;
worker_processes auto;

events {
  worker_connections 1024;
}

http {
  server {
    listen 8080;
    listen [::]:8080;

    location / {
      root /usr/share/nginx/html;
      index index.html index.htm;
    }
  }
}
EOF

# Reload Nginx configuration
systemctl reload nginx

# Check if Nginx is running as the nginx user
if ! ps aux | grep -v grep | grep -q nginx; then
  echo "Nginx is not running as the nginx user. Please check the configuration."
  exit 1
fi

echo "Nginx has been configured to run as the nginx user and listen on all active IPs on port 8080."
